import './polyfills.server.mjs';
import{c as te}from"./chunk-CAK3DAMF.mjs";import{c as J,f as W}from"./chunk-LZ45RK54.mjs";import{b as B,d as V,e as X,f as ee}from"./chunk-YZJYNVE5.mjs";import{rb as Y,tb as $}from"./chunk-EKK5QDHO.mjs";import{$ as A,Aa as T,Ca as w,Ea as H,Fa as C,Ha as q,J as x,Ka as F,La as I,Oa as G,Pa as Z,Ta as z,Ua as d,Zb as K,f as O,ka as _,yb as Q}from"./chunk-H5UHAHI5.mjs";import{$d as k,Aa as E,Fa as u,Ga as m,Ia as f,Ka as o,La as M,S as a,Sa as g,Td as l,Vd as P,X as N,cb as L,x as R,xa as v}from"./chunk-TXWRNZDJ.mjs";import{a as h}from"./chunk-GHFNAT2I.mjs";var D=new f("UserProfileNormalizer"),ne=new f("UserProfileSerializer"),Re=new f("UserSerializer"),ce=new f("UserSignUpSerializer"),ae=new f("TitleNormalizer"),U=class{},S=(()=>{class r{constructor(e){this.userProfileAdapter=e}update(e,t){return this.userProfileAdapter.update(e,t)}register(e){return this.userProfileAdapter.register(e)}registerGuest(e,t){return this.userProfileAdapter.registerGuest(e,t)}requestForgotPasswordEmail(e){return this.userProfileAdapter.requestForgotPasswordEmail(e)}resetPassword(e,t){return this.userProfileAdapter.resetPassword(e,t)}updateEmail(e,t,s){return this.userProfileAdapter.updateEmail(e,t,s)}updatePassword(e,t,s){return this.userProfileAdapter.updatePassword(e,t,s)}remove(e){return this.userProfileAdapter.close(e)}getTitles(){return this.userProfileAdapter.loadTitles()}static{this.\u0275fac=function(t){return new(t||r)(o(U))}}static{this.\u0275prov=u({token:r,factory:r.\u0275fac})}}return r})(),re=(()=>{class r{constructor(e,t,s){this.userIdService=e,this.userProfileConnector=t,this.command=s,this.updateCommand=this.command.create(i=>this.userIdService.takeUserId(!0).pipe(v(n=>this.userProfileConnector.updateEmail(n,i.password,i.newUid))),{strategy:F.Queue})}update(e,t){return this.updateCommand.execute({password:e,newUid:t})}static{this.\u0275fac=function(t){return new(t||r)(o(A),o(S),o(I))}}static{this.\u0275prov=u({token:r,factory:r.\u0275fac})}}return r})(),ie=(()=>{class r{constructor(e,t,s){this.userProfileConnector=e,this.userIdService=t,this.command=s,this.updateCommand=this.command.create(i=>this.userIdService.takeUserId(!0).pipe(N(1),v(n=>this.userProfileConnector.updatePassword(n,i.oldPassword,i.newPassword)))),this.resetCommand=this.command.create(i=>this.userProfileConnector.resetPassword(i.token,i.password)),this.requestForgotPasswordEmailCommand=this.command.create(i=>this.userProfileConnector.requestForgotPasswordEmail(i.email))}update(e,t){return this.updateCommand.execute({oldPassword:e,newPassword:t})}reset(e,t){return this.resetCommand.execute({token:e,password:t})}requestForgotPasswordEmail(e){return this.requestForgotPasswordEmailCommand.execute({email:e})}static{this.\u0275fac=function(t){return new(t||r)(o(S),o(A),o(I))}}static{this.\u0275prov=u({token:r,factory:r.\u0275fac})}}return r})(),b=(()=>{class r{constructor(e,t,s,i,n,c,p){this.userAccountService=e,this.authService=t,this.userProfileConnector=s,this.eventService=i,this.userIdService=n,this.query=c,this.command=p,this.updateCommand=this.command.create(j=>this.userIdService.takeUserId(!0).pipe(v(he=>this.userProfileConnector.update(he,j.details).pipe(E(()=>{this.eventService.dispatch({user:j.details},W)})))),{strategy:F.Queue}),this.closeCommand=this.command.create(()=>this.userIdService.takeUserId(!0).pipe(v(j=>this.userProfileConnector.remove(j).pipe(E(()=>this.authService.logout()))))),this.titleQuery=this.query.create(()=>this.userProfileConnector.getTitles(),{reloadOn:[K]})}get(){return this.userAccountService.get()}update(e){return this.updateCommand.execute({details:e})}close(){return this.closeCommand.execute(void 0)}getTitles(){return this.titleQuery.get().pipe(R(e=>e??[]))}static{this.\u0275fac=function(t){return new(t||r)(o(J),o(T),o(S),o(G),o(A),o(Z),o(I))}}static{this.\u0275prov=u({token:r,factory:r.\u0275fac})}}return r})(),se=(()=>{class r{constructor(e,t,s,i,n){this.userProfile=e,this.userConnector=t,this.authService=s,this.command=i,this.store=n,this.registerCommand=this.command.create(({user:c})=>this.userConnector.register(c).pipe(E(()=>{this.store.dispatch(new Q.RegisterUserSuccess)}))),this.registerGuestCommand=this.command.create(c=>this.userConnector.registerGuest(c.guid,c.password).pipe(E(p=>{this.authService.loginWithCredentials(p.uid,c.password)})))}register(e){return this.registerCommand.execute({user:e})}registerGuest(e,t){return this.registerGuestCommand.execute({guid:e,password:t})}getTitles(){return this.userProfile.getTitles()}static{this.\u0275fac=function(t){return new(t||r)(o(b),o(S),o(T),o(I),o(O))}}static{this.\u0275prov=u({token:r,factory:r.\u0275fac})}}return r})(),me=[re,ie,b,se,{provide:V,useExisting:re},{provide:X,useExisting:ie},{provide:B,useExisting:b},{provide:ee,useExisting:se}],de=(()=>{class r{static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275mod=g({type:r})}static{this.\u0275inj=m({providers:[S,...me]})}}return r})();var fe={backend:{occ:{endpoints:{userRegister:"users",userForgotPassword:"forgottenpasswordtokens",userResetPassword:"resetpassword",userUpdateLoginId:"users/${userId}/login",userUpdatePassword:"users/${userId}/password",titles:"titles"}}}},ue={"Content-Type":"application/json"},y={"Content-Type":"application/x-www-form-urlencoded"},ge=(()=>{class r{constructor(e,t,s){this.http=e,this.occEndpoints=t,this.converter=s,this.logger=M(_),this.captchaConfig=M(Y,{optional:!0}),this.injector=M(L,{optional:!0})}update(e,t){let s=this.occEndpoints.isConfigured("userUpdateProfile")?"userUpdateProfile":"user",i=this.occEndpoints.buildUrl(s,{urlParams:{userId:e}});return t=this.converter.convert(t,ne),this.http.patch(i,t).pipe(a(n=>{throw d(n,this.logger)}))}register(e){let t=this.occEndpoints.buildUrl("userRegister"),s=new l(h({},ue));return s=C.createHeader(w,!0,s),s=this.appendCaptchaToken(s),e=this.converter.convert(e,ce),this.http.post(t,e,{headers:s}).pipe(a(i=>{throw d(i,this.logger)}),this.converter.pipeable(D))}registerGuest(e,t){let s=this.occEndpoints.buildUrl("userRegister"),i=new l(h({},y));i=C.createHeader(w,!0,i),i=this.appendCaptchaToken(i);let n=new P().set("guid",e).set("password",t);return this.http.post(s,n,{headers:i}).pipe(a(c=>{throw d(c,this.logger)}),this.converter.pipeable(D))}requestForgotPasswordEmail(e){let t=this.occEndpoints.buildUrl("userForgotPassword"),s=new P().set("userId",e),i=new l(h({},y));return i=C.createHeader(w,!0,i),this.http.post(t,s,{headers:i}).pipe(a(n=>{throw d(n,this.logger)}))}resetPassword(e,t){let s=this.occEndpoints.buildUrl("userResetPassword"),i=new l(h({},ue));return i=C.createHeader(w,!0,i),this.http.post(s,{token:e,newPassword:t},{headers:i}).pipe(a(n=>{throw d(n,this.logger)}))}updateEmail(e,t,s){let i=this.occEndpoints.buildUrl("userUpdateLoginId",{urlParams:{userId:e}}),n=new P().set("password",t).set("newLogin",s),c=new l(h({},y));return this.http.put(i,n,{headers:c}).pipe(a(p=>{throw d(p,this.logger)}))}updatePassword(e,t,s){let i=this.occEndpoints.buildUrl("userUpdatePassword",{urlParams:{userId:e}}),n=new P().set("old",t).set("new",s),c=new l(h({},y));return this.http.put(i,n,{headers:c}).pipe(a(p=>{throw d(p,this.logger)}))}close(e){let t=this.occEndpoints.isConfigured("userCloseAccount")?"userCloseAccount":"user",s=this.occEndpoints.buildUrl(t,{urlParams:{userId:e}});return this.http.delete(s).pipe(a(i=>{throw d(i,this.logger)}))}loadTitles(){let e=this.occEndpoints.buildUrl("titles");return this.http.get(e).pipe(a(t=>{throw d(t,this.logger)}),R(t=>t.titles??[]),this.converter.pipeableMany(ae))}appendCaptchaToken(e){if(this.injector&&this.captchaConfig?.captchaRenderer){let t=this.injector.get(this.captchaConfig.captchaRenderer),s=t.getCaptchaConfig().subscribe(i=>i.enabled);if(t?.getToken()&&s)return e.append(H,t.getToken())}return e}static{this.\u0275fac=function(t){return new(t||r)(o(k),o(q),o(z))}}static{this.\u0275prov=u({token:r,factory:r.\u0275fac})}}return r})(),pe=(()=>{class r{static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275mod=g({type:r})}static{this.\u0275inj=m({providers:[x(fe),{provide:U,useClass:ge}]})}}return r})();var Ze=(()=>{class r{static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275mod=g({type:r})}static{this.\u0275inj=m({imports:[de,pe,te,$]})}}return r})();export{Ze as UserProfileModule};
